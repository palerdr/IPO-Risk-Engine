# IPO Hand Engine - Build Progress

## Current Status: Phase 2 — Universe Expansion + Pipeline Hardening

Last updated: 2026-02-11

---

## Phase 1: Baseline Pipeline (COMPLETE)

### Completed Milestones (M0-M7)
- [x] M0: Project cleanup, unified PRD
- [x] M1: Multi-timeframe ingestion (Alpaca SIP, 5m/1h/1d bars)
- [x] M2: Street windows (FLOP→5m, TURN→1h, RIVER→1d)
- [x] M3-M5: 22 features across 3 streets
- [x] M6: Forward MDD/MFR labels
- [x] M7: Snapshot builder (94 symbols × 3 streets)

### 8-Point Architectural Reframe (COMPLETE)
- [x] Target reframing: risk_severity, adverse_event_15 (tau=0.15), severe_tail_20
- [x] Street-stratified baselines: FLOP/TURN constant, RIVER Ridge+KNN
- [x] RiverCommittee: Ridge(1000) + KNN(7) with shared StandardScaler
- [x] Calibration: Platt, isotonic, binned (Laplace + PAV monotonicity)
- [x] OOF temporal expanding-fold calibration (select_calibrator_oof)
- [x] True OOF committee scores (build_oof_calibration_frame)
- [x] Hardened calibrator selection: bootstrap CI + selection rule
- [x] Policy layer: assign_action, false_safe_rate, optimize_thresholds
- [x] Shuffle-leakage test (p=0.19, no leakage)
- [x] End-to-end pipeline (scripts/run_full_pipeline.py)

### Baseline Results (94 symbols, 75 RIVER train+val, 19 test)
- Calibrator: binned (hardened selection, isotonic gap < 0.03)
- OOF BSS: -0.026 (below climatology — data-starved, not broken)
- Test BSS: -0.244 (expected with 19 test points)
- Test false-safe rate: 0% (no severe event got SIZE_UP)
- Test adverse detection: 100% (all adverse events got FOLD)
- Shuffle p-value: 0.190 (no leakage)
- Diagnosis: pipeline is architecturally sound, needs >500 RIVER samples

---

## Phase 2: Universe Expansion + Defensibility (ACTIVE)

### 2.1 Expand Universe
- [ ] Build IPO universe from SEC EDGAR (primary: S-1/F-1 filings)
- [ ] Pre-register inclusion rules:
  - Common stocks on NYSE/Nasdaq
  - Exclude: SPACs, ADRs, ETFs, direct listings
  - Minimum 20 trading days post-IPO
  - Valid OHLCV coverage for FLOP/TURN/RIVER windows
- [ ] Validate first-trade dates via Alpaca
- [ ] Reconcile annual totals against Jay Ritter academic data
- [ ] Track delistings/dead names (survivorship bias)
- [ ] Target: >=500 RIVER samples, >=50 severe_tail events

### 2.2 Modeling Defensibility
- [ ] Ranking policy mode (score quantiles) — use before calibration is trustworthy
- [ ] Calibration gate: don't calibrate severe-tail until 50+ severe events in train
- [ ] Champion/challenger ladder: Constant → Ridge → KNN → Committee
- [ ] Freeze evaluation protocol: expanding time splits by IPO date

### 2.3 Risk Decision Hardening
- [x] Dual labels: adverse_event_15 (model) + severe_tail_20 (safety audit)
- [x] False-safe rate constraint in threshold optimization
- [ ] SIZE_UP coverage floor (prevent all-FOLD collapse)
- [ ] Action-bucket outcome reporting (worst-decile MDD per action)

### 2.4 Robustness Evidence
- [x] Shuffle-leakage test
- [ ] Future-shift sentinel test
- [ ] Stability slices: sector, market regime, deal size/liquidity
- [x] Bootstrap CIs for BSS
- [ ] Versioned artifacts: dataset hash, split manifest, model config, seed

### Targets Before "Production-Grade Research"
- >= 500 RIVER samples
- >= 50 severe-tail events
- Stable false-safe rate across 3+ time splits
- Policy better than climatology on out-of-time tests

---

## Data Source Architecture

### Primary: SEC EDGAR (free, no API key for data.sec.gov)
- S-1/F-1 filings → IPO registration intent + CIK
- 424B* filings → IPO pricing date
- company_tickers_exchange.json → CIK→ticker mapping
- Auditable, high-authority, defensible timestamps

### Market Data: Alpaca (free tier, SIP feed)
- Historical bars: 5m, 1h, 1d
- First-trade validation for IPO universe
- Forward label computation (MDD/MFR)

### Validation: Jay Ritter Academic Data
- Benchmark yearly IPO counts
- Underpricing regime context
- Long-horizon sanity checks (1980-2025)

### Supplemental: Finnhub (free tier, if needed)
- Recent/upcoming IPO gap-fill only
- Reconcile against SEC/Ritter before trusting

---

## Active File Inventory

### Package (src/ipo_risk_engine/)
| File | Purpose |
|------|---------|
| config/settings.py | Alpaca auth, env vars |
| data/alpaca_client.py | get_bars() multi-timeframe |
| data/ingest.py | ingest_bars() + normalize |
| data/store.py | raw_bars_path(), read/write parquet |
| data/schemas.py | BASE_BAR_SCHEMA, validate_bars() |
| features/streets.py | Street definitions + timeframe mapping |
| features/street_features.py | ALL 22 features (FLOP, TURN, RIVER) |
| labels/mdd.py | compute_forward_mdd() |
| dataset/assemble.py | Snapshot → DataFrame with derived targets |
| models/baseline.py | BaselineModel, BaseRidge, FiveKNN |
| models/committee.py | RiverCommittee (Ridge+KNN ensemble) |
| models/calibrate.py | Platt/isotonic/binned calibrators, OOF selection |
| models/evaluate.py | evaluate_predictions, evaluate_by_group |
| policy/actions.py | assign_action, optimize_thresholds, false_safe_rate |

### Scripts
| File | Purpose |
|------|---------|
| scripts/build_dataset.py | Universe → snapshots → train/val/test parquet |
| scripts/run_baselines.py | Street-stratified baseline evaluation |
| scripts/run_full_pipeline.py | End-to-end: OOF → calibration → policy → test |
| scripts/build_ipo_universe.py | Intrinio-driven universe builder |
| scripts/build_universe_edgar.py | SEC EDGAR-driven universe builder (TODO) |
